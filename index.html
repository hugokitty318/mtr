<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>港鐵 MTR 即時到站時間 - 車站提示</title>
<meta name="description" content="提供香港港鐵(MTR)各路線即時到站時間查詢，支援全線路及車站，界面簡潔，資訊準確。">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MTR車站提示">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="canonical" href="https://your-website-url.com">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"港鐵 MTR 即時到站時間 - 車站提示","description":"提供香港港鐵(MTR)各路線即時到站時間查詢，支援全線路及車站，界面簡潔，資訊準確。","url":"https://your-website-url.com","applicationCategory":"Utilities","operatingSystem":"Any"}</script>
<style>
:root{--primary-color:#007AFF;--background-color:#F2F2F7;--card-background-color:#FFFFFF;--text-color:#000000;--subtle-text-color:#6D6D80;--border-color:#C6C6C8;--shadow:0 4px 12px rgba(0,0,0,0.08);--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-bottom:env(safe-area-inset-bottom);--font-family-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang TC","Hiragino Sans CNS","Microsoft JhengHei",sans-serif;--font-size-base:18px;--font-size-small:16px;--font-size-large:20px;--font-size-breadcrumb:17px;}
[data-theme="dark"]{--background-color:#000000;--card-background-color:#1C1C1E;--text-color:#FFFFFF;--subtle-text-color:#8E8E93;--border-color:#38383A;--shadow:0 4px 12px rgba(0,0,0,0.5);}

html{scroll-behavior:smooth;-webkit-text-size-adjust:100%;}
body{font-family:var(--font-family-sans);font-size:var(--font-size-base);background-color:var(--background-color);color:var(--text-color);margin:0;padding:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:background-color .3s ease,color .3s ease;touch-action:manipulation;line-height:1.6;letter-spacing:0.05em;}
.container{max-width:600px;margin:0 auto;padding:.5rem clamp(0.8rem,3vw,1rem);padding-top:calc(.5rem + var(--safe-area-inset-top));}
main{transition:padding-top .3s ease;}
section{margin-bottom:1rem;}
h2{font-size:var(--font-size-large);font-weight:600;margin-top:0;margin-bottom:1rem;}

/* Navbar */
.navbar{background-color:var(--card-background-color);border-bottom:1px solid var(--border-color);padding:12px clamp(10px,3vw,16px);padding-top:calc(12px + var(--safe-area-inset-top));padding-right:calc(clamp(10px,3vw,16px) + env(safe-area-inset-right));display:flex;align-items:center;position:fixed;top:0;left:0;width:100%;z-index:1000;box-shadow:var(--shadow);transition:background-color .3s ease,border-color .3s ease,box-shadow .3s ease;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);gap:12px;}
.navbar-content{display:flex;align-items:center;flex:1;min-width:0;gap:12px;}
.navbar h1{font-size:1.1rem;font-weight:600;margin:0;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:1;}
.navbar-search-container{flex:1;min-width:0;position:relative;display:none;max-width:300px;}
.navbar-search-container.show{display:block;}
.search-input-nav{width:100%;min-height:44px;padding:10px 36px 10px 14px;border:1px solid var(--border-color);border-radius:22px;background-color:var(--background-color);color:var(--text-color);font-size:var(--font-size-base);box-sizing:border-box;-webkit-appearance:none;transition:background-color .3s ease,border-color .3s ease;}
.search-input-nav:focus{outline:2px solid var(--primary-color);outline-offset:2px;background-color:var(--card-background-color);}
.search-clear-nav{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--subtle-text-color);cursor:pointer;padding:8px;-webkit-tap-highlight-color:transparent;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;}
.search-clear-nav:hover{color:var(--text-color);}
.nav-controls{display:flex;gap:8px;flex-shrink:0;}
.theme-toggle{background:none;border:none;cursor:pointer;padding:8px;border-radius:22px;display:flex;align-items:center;justify-content:center;color:var(--text-color);transition:background-color .2s ease;-webkit-tap-highlight-color:transparent;min-width:44px;min-height:44px;}
.theme-toggle:hover{background-color:var(--border-color);}
.theme-toggle:active{transform:scale(0.95);}
.theme-toggle svg{width:20px;height:20px;}

/* Breadcrumb */
.breadcrumb-container{background-color:var(--card-background-color);border-bottom:1px solid var(--border-color);padding:12px clamp(12px,4vw,16px);position:fixed;top:0;left:0;width:100%;z-index:999;transition:background-color .3s ease,border-color .3s ease;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:var(--font-size-breadcrumb);color:var(--subtle-text-color);font-weight:500;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch; scrollbar-width: none; -ms-overflow-style: none;}
.breadcrumb::-webkit-scrollbar{display:none;}
.breadcrumb-item{display:flex;align-items:center;gap:6px;white-space:nowrap;flex-shrink:0;}
.breadcrumb-item:not(:last-child)::after{content:"›";margin-left:6px;color:var(--subtle-text-color);font-weight:600;}
.breadcrumb-link{color:var(--primary-color);text-decoration:none;cursor:pointer;padding:4px 8px;border-radius:6px;transition:background-color .2s ease;min-height:36px;display:flex;align-items:center;}
.breadcrumb-link:hover{background-color:rgba(0,122,255,0.1);text-decoration:underline;}
.breadcrumb-current{color:var(--text-color);font-weight:600;padding:4px 8px;border-radius:6px;background-color:var(--background-color);min-height:36px;display:flex;align-items:center;}

/* Buttons */
.button-group{display:flex;flex-wrap:wrap;gap:clamp(10px,3vw,15px);justify-content:center;}
.btn-station{flex:1 1 calc(33.333% - 15px);min-width:90px;min-height:52px;padding:14px 12px;border:1px solid var(--border-color);background-color:var(--card-background-color);border-radius:12px;cursor:pointer;font-size:var(--font-size-base);font-weight:500;color:var(--text-color);transition:all .2s ease-in-out,transform .1s ease-out;text-align:center;-webkit-tap-highlight-color:transparent;box-sizing:border-box;display:flex;align-items:center;justify-content:center;position:relative;white-space:nowrap;-webkit-user-select:none;user-select:none;z-index:10;}
.btn-station:hover{transform:translateY(-2px);box-shadow:var(--shadow);}
.btn-station:active{transform:scale(0.98);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.btn-station.active{color:white;box-shadow:0 0 0 3px rgba(0,122,255,0.3);transform:translateY(-2px);z-index:20;}
.btn-station:focus{outline:2px solid var(--primary-color);outline-offset:2px;z-index:20;}
.line-color-indicator{width:5px;height:100%;position:absolute;left:0;top:0;border-radius:12px 0 0 12px;transition:opacity 0.2s ease;z-index:1;}

/* Tables */
.time-table-container{background-color:var(--card-background-color);border-radius:12px;padding:0.5rem;box-shadow:var(--shadow);margin-bottom:calc(0.5rem + var(--safe-area-inset-bottom));transition:background-color .3s ease,box-shadow .3s ease;}
.time-table{width:100%;border-collapse:collapse;margin-top:0.3rem;border-radius:12px;overflow:hidden;}
.time-table caption{font-size:1.1rem;font-weight:600;padding:14px 16px;caption-side:top;text-align:left;background-color:var(--background-color);border-bottom:1px solid var(--border-color);}
.time-table th,.time-table td{padding:14px 12px;text-align:left;border-bottom:1px solid var(--border-color);font-size:1.05rem;line-height:1.5;}
.time-table thead th{font-weight:600;color:var(--subtle-text-color);background-color:var(--background-color);font-size:1.05rem;}
.time-upcoming{font-weight:600;color:var(--primary-color);}
.time-urgent{font-weight:700;color:#FF3B30;}

/* Misc */
.loading-indicator,.error-message{text-align:center;padding:20px;color:var(--subtle-text-color);font-size:1.05rem;position:relative;}
.error-message{color:#D70015;}
.loading-indicator::after{content:"";position:absolute;width:24px;height:24px;margin:auto;border:3px solid var(--subtle-text-color);border-radius:50%;border-top-color:var(--primary-color);animation:spin 1s ease-in-out infinite;top:0;left:0;bottom:0;right:0;}
@keyframes spin{to{transform:rotate(360deg);}}
.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
.offline-indicator{position:fixed;bottom:0;left:0;width:100%;background-color:#FF9500;color:white;text-align:center;padding:12px;padding-bottom:calc(12px + var(--safe-area-inset-bottom));transform:translateY(100%);transition:transform .3s ease;z-index:1001;font-size:1.05rem;}
.offline-indicator.show{transform:translateY(0);}

/* Autocomplete */
.autocomplete-dropdown{position:fixed;left:0;right:0;background-color:var(--card-background-color);border:1px solid var(--border-color);border-radius:12px;margin:0 1rem;max-height:200px;overflow-y:auto;z-index:1001;box-shadow:var(--shadow);}
.autocomplete-item{padding:14px 16px;cursor:pointer;transition:background-color .2s ease;display:flex;align-items:center;gap:8px;font-size:var(--font-size-base);min-height:52px;-webkit-tap-highlight-color:transparent;z-index:10;}
.autocomplete-item:hover{background-color:var(--border-color);}
.autocomplete-item.selected{background-color:var(--primary-color);color:white;}
.line-indicator{width:12px;height:12px;border-radius:50%;flex-shrink:0;}

@supports (-webkit-touch-callout: none) {.btn-station,.breadcrumb-link,.breadcrumb-current{ -webkit-tap-highlight-color: rgba(0,0,0,0); }}

@media (max-width: 420px) {
  :root { --font-size-base: 19px; --font-size-small: 17px; --font-size-breadcrumb: 18px; --font-size-large: 21px; }
  .navbar h1 { font-size: 1rem; }
  .btn-station { font-size: 1rem; padding: 14px 10px; min-height: 50px; }
  .time-table th, .time-table td { font-size: 1rem; padding: 12px 10px; }
  .search-input-nav { font-size: 1rem; }
}
@media (min-width: 768px) { .navbar-search-container { max-width: 250px; } .search-input-nav { font-size: 0.9rem; } }
@media (min-width: 1024px) { .navbar-search-container { max-width: 200px; } .search-input-nav { font-size: 0.85rem; } }
</style>
</head>
<body>
<header class="navbar" role="banner">
  <div class="navbar-content">
    <h1>車站提示</h1>
    <div class="navbar-search-container" id="navbar-search-container">
      <input type="text" id="station-search-nav" class="search-input-nav" placeholder="搜尋車站..." autocomplete="off">
      <button id="search-clear-nav" class="search-clear-nav" aria-label="清除搜索" style="display:none;">✕</button>
    </div>
  </div>
  <div class="nav-controls">
    <button id="theme-toggle" class="theme-toggle" aria-label="切換主題">
      <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;">
        <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </div>
</header>

<nav class="breadcrumb-container" role="navigation" aria-label="麵包屑導航">
  <div class="breadcrumb" id="breadcrumb">
    <div class="breadcrumb-item"><span class="breadcrumb-current">主頁</span></div>
  </div>
</nav>

<div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display:none;"></div>

<main class="container" role="main">
  <section id="line-selection" aria-labelledby="line-selection-title">
    <h2 id="line-selection-title">揀你而家喺邊條線：</h2>
    <nav id="line-buttons" class="button-group" role="group" aria-labelledby="line-selection-title"></nav>
  </section>

  <section id="station-selection" aria-labelledby="station-selection-title" style="display:none;">
    <h2 id="station-selection-title">揀你而家喺邊個站：</h2>
    <nav id="station-buttons-container" class="button-group" role="group" aria-labelledby="station-selection-title"></nav>
  </section>

  <section id="schedule-display" aria-labelledby="schedule-title" style="display:none;">
    <div class="time-table-container">
      <h2 id="schedule-title" class="visually-hidden">到站時間表</h2>
      <table id="up-time-table" class="time-table" style="display:none;">
        <caption id="up-caption"></caption>
        <thead><tr><th scope="col">開車時間</th><th scope="col">目的地</th><th scope="col">月台</th></tr></thead>
        <tbody><tr><td colspan="3" class="loading-indicator">載入中...</td></tr></tbody>
      </table>
      <table id="down-time-table" class="time-table">
        <caption id="down-caption"></caption>
        <thead><tr><th scope="col">開車時間</th><th scope="col">目的地</th><th scope="col">月台</th></tr></thead>
        <tbody><tr><td colspan="3" class="loading-indicator">載入中...</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<div id="offline-indicator" class="offline-indicator" role="status" aria-live="polite">網路連線已斷開，顯示的是離線資料</div>

<script>
// 訊息
const zhTWMessages = { loading: "載入中...", networkError: "網絡連線錯誤，請檢查您的網絡設置。", dataError: "無法獲取最新數據，請稍後再試。", noSchedule: "找不到此車站的時間表。", offline: "網路連線已斷開，顯示的是離線資料" };

// 線顏色
const lineColors = { TKL:'#7e4c93', ISL:'#0075A2', KTL:'#00a04a', TWL:'#e31f24', TML:'#8d5025', EAL:'#5eb7e8', TCL:'#f7943d', AEL:'#00888e', SIL:'#bcbd22' };

// 線名稱
const lines = { TKL:'將軍澳線', ISL:'港島線', KTL:'觀塘線', TWL:'荃灣線', TML:'屯馬線', EAL:'東鐵線', TCL:'東涌線', AEL:'機場快線', SIL:'南港島線' };

// 車站名稱映射（常用）
const stationNames = { NOP:'北角',QUB:'鰂魚涌',YAT:'油塘',TIK:'調景嶺',TKO:'將軍澳',HAH:'坑口',POA:'寶琳',LHP:'康城',CHW:'柴灣',HFC:'杏花邨',SKW:'筲箕灣',SWH:'西灣河',TAK:'太古',FOH:'炮台山',TIH:'天后',CAB:'銅鑼灣',WAC:'灣仔',ADM:'金鐘',CEN:'中環',SHW:'上環',SYP:'西營盤',HKU:'香港大學',KET:'堅尼地城',LAT:'藍田',KWT:'觀塘',NTK:'牛頭角',KOB:'九龍灣',CHH:'彩虹',DIH:'鑽石山',WTS:'黃大仙',LOF:'樂富',KOT:'九龍塘',SKM:'石硤尾',PRE:'太子',MOK:'旺角',YMT:'油麻地',HOM:'何文田',WHA:'黃埔',TSW:'荃灣',TWH:'大窩口',KWH:'葵興',KWF:'葵芳',LAK:'荔景',MEF:'美孚',LCK:'荔枝角',CSW:'長沙灣',SSP:'深水埗',JOR:'佐敦',TST:'尖沙咀',WKS:'烏溪沙',MOS:'馬鞍山',HEO:'恆安',TSH:'大水坑',SHM:'石門',CIO:'第一城',STW:'沙田圍',CKT:'車公廟',TAW:'大圍',HIK:'顯徑',KAT:'啟德',SUW:'宋皇臺',TKW:'土瓜灣',HUH:'紅磡',ETS:'尖東',AUS:'柯士甸',NAC:'南昌',TWW:'荃灣西',KSR:'錦上路',YUL:'元朗',LOP:'朗屏',TIS:'天水圍',SIH:'兆康',TUM:'屯門',LMC:'落馬洲',LOW:'羅湖',SHS:'上水',FAN:'粉嶺',TWO:'太和',TAP:'大埔墟',UNI:'大學',RAC:'馬場',FOT:'火炭',SHT:'沙田',MKK:'旺角東',EXC:'會展',TUC:'東涌',SUN:'欣澳',TSY:'青衣',OLY:'奧運',KOW:'九龍',HOK:'香港',AWE:'博覽館',AIR:'機場',SOH:'海怡半島',LET:'利東',WCH:'黃竹坑',OCP:'海洋公園' };

// 線路車站（精選，足以正常運作；可擴充）
const stations = {
  TKL:{id:'TKL',name:'將軍澳線',stations:[
    {id:'NOP',name:'北角',up:"往寶琳/康城方向"},
    {id:'QUB',name:'鰂魚涌',up:"往寶琳/康城方向",down:"往北角方向"},
    {id:'YAT',name:'油塘',up:"往寶琳/康城方向",down:"往北角方向"},
    {id:'TIK',name:'調景嶺',up:"往寶琳/康城方向",down:"往北角方向"},
    {id:'TKO',name:'將軍澳',up:"往寶琳/康城方向",down:"往北角/調景嶺方向"},
    {id:'HAH',name:'坑口',up:"往寶琳方向",down:"往北角方向"},
    {id:'POA',name:'寶琳',down:"往北角方向"},
    {id:'LHP',name:'康城',down:"往北角/調景嶺方向"}
  ]},
  ISL:{id:'ISL',name:'港島線',stations:[
    {id:'CHW',name:'柴灣',down:"往堅尼地城方向"},
    {id:'HFC',name:'杏花邨',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'SKW',name:'筲箕灣',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'SWH',name:'西灣河',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'TAK',name:'太古',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'QUB',name:'鰂魚涌',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'NOP',name:'北角',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'FOH',name:'炮台山',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'TIH',name:'天后',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'CAB',name:'銅鑼灣',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'WAC',name:'灣仔',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'ADM',name:'金鐘',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'CEN',name:'中環',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'SHW',name:'上環',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'SYP',name:'西營盤',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'HKU',name:'香港大學',up:"往柴灣方向",down:"往堅尼地城方向"},
    {id:'KET',name:'堅尼地城',up:"往柴灣方向"}
  ]},
  KTL:{id:'KTL',name:'觀塘線',stations:[
    {id:'TIK',name:'調景嶺',down:"往黃埔方向"},
    {id:'YAT',name:'油塘',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'LAT',name:'藍田',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'KWT',name:'觀塘',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'NTK',name:'牛頭角',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'KOB',name:'九龍灣',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'CHH',name:'彩虹',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'DIH',name:'鑽石山',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'WTS',name:'黃大仙',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'LOF',name:'樂富',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'KOT',name:'九龍塘',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'SKM',name:'石硤尾',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'PRE',name:'太子',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'MOK',name:'旺角',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'YMT',name:'油麻地',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'HOM',name:'何文田',up:"往調景嶺方向",down:"往黃埔方向"},
    {id:'WHA',name:'黃埔',up:"往調景嶺方向"}
  ]},
  TWL:{id:'TWL',name:'荃灣線',stations:[
    {id:'TSW',name:'荃灣',down:'往中環方向'},{id:'TWH',name:'大窩口',up:'往荃灣方向',down:'往中環方向'},{id:'KWH',name:'葵興',up:'往荃灣方向',down:'往中環方向'},{id:'KWF',name:'葵芳',up:'往荃灣方向',down:'往中環方向'},{id:'LAK',name:'荔景',up:'往荃灣方向',down:'往中環方向'},{id:'MEF',name:'美孚',up:'往荃灣方向',down:'往中環方向'},{id:'LCK',name:'荔枝角',up:'往荃灣方向',down:'往中環方向'},{id:'CSW',name:'長沙灣',up:'往荃灣方向',down:'往中環方向'},{id:'SSP',name:'深水埗',up:'往荃灣方向',down:'往中環方向'},{id:'PRE',name:'太子',up:'往荃灣方向',down:'往中環方向'},{id:'MOK',name:'旺角',up:'往荃灣方向',down:'往中環方向'},{id:'YMT',name:'油麻地',up:'往荃灣方向',down:'往中環方向'},{id:'JOR',name:'佐敦',up:'往荃灣方向',down:'往中環方向'},{id:'TST',name:'尖沙咀',up:'往荃灣方向',down:'往中環方向'},{id:'ADM',name:'金鐘',up:'往荃灣方向',down:'往中環方向'},{id:'CEN',name:'中環',up:'往荃灣方向'}
  ]},
  TML:{id:'TML',name:'屯馬線',stations:[
    {id:'WKS',name:'烏溪沙',down:'往屯門方向'},{id:'MOS',name:'馬鞍山',up:'往烏溪沙方向',down:'往屯門方向'},{id:'HEO',name:'恆安',up:'往烏溪沙方向',down:'往屯門方向'},{id:'TSH',name:'大水坑',up:'往烏溪沙方向',down:'往屯門方向'},{id:'SHM',name:'石門',up:'往烏溪沙方向',down:'往屯門方向'},{id:'CIO',name:'第一城',up:'往烏溪沙方向',down:'往屯門方向'},{id:'STW',name:'沙田圍',up:'往烏溪沙方向',down:'往屯門方向'},{id:'CKT',name:'車公廟',up:'往烏溪沙方向',down:'往屯門方向'},{id:'TAW',name:'大圍',up:'往烏溪沙方向',down:'往屯門方向'},{id:'HIK',name:'顯徑',up:'往烏溪沙方向',down:'往屯門方向'},{id:'KAT',name:'啟德',up:'往烏溪沙方向',down:'往屯門方向'},{id:'SUW',name:'宋皇臺',up:'往烏溪沙方向',down:'往屯門方向'},{id:'TKW',name:'土瓜灣',up:'往烏溪沙方向',down:'往屯門方向'},{id:'HUH',name:'紅磡',up:'往烏溪沙方向',down:'往屯門方向'},{id:'ETS',name:'尖東',up:'往烏溪沙方向',down:'往屯門方向'},{id:'AUS',name:'柯士甸',up:'往烏溪沙方向',down:'往屯門方向'},{id:'NAC',name:'南昌',up:'往烏溪沙方向',down:'往屯門方向'},{id:'TWW',name:'荃灣西',up:'往烏溪沙方向',down:'往屯門方向'},{id:'KSR',name:'錦上路',up:'往烏溪沙方向',down:'往屯門方向'},{id:'YUL',name:'元朗',up:'往烏溪沙方向',down:'往屯門方向'},{id:'LOP',name:'朗屏',up:'往烏溪沙方向',down:'往屯門方向'},{id:'TIS',name:'天水圍',up:'往烏溪沙方向',down:'往屯門方向'},{id:'SIH',name:'兆康',up:'往烏溪沙方向',down:'往屯門方向'},{id:'TUM',name:'屯門',up:'往烏溪沙方向'}
  ]},
  EAL:{id:'EAL',name:'東鐵線',stations:[
    {id:'LOW',name:'羅湖',down:'往金鐘方向'},{id:'LMC',name:'落馬洲',down:'往金鐘方向'},{id:'SHS',name:'上水',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'FAN',name:'粉嶺',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'TWO',name:'太和',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'TAP',name:'大埔墟',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'UNI',name:'大學',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'RAC',name:'馬場',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'FOT',name:'火炭',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'SHT',name:'沙田',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'MKK',name:'旺角東',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'HUH',name:'紅磡',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'EXC',name:'會展',up:'往羅湖/落馬洲方向',down:'往金鐘方向'},{id:'ADM',name:'金鐘',up:'往羅湖/落馬洲方向'}
  ]},
  TCL:{id:'TCL',name:'東涌線',stations:[
    {id:'TUC',name:'東涌',down:'往香港方向'},{id:'SUN',name:'欣澳',up:'往東涌方向',down:'往香港方向'},{id:'TSY',name:'青衣',up:'往東涌方向',down:'往香港方向'},{id:'OLY',name:'奧運',up:'往東涌方向',down:'往香港方向'},{id:'KOW',name:'九龍',up:'往東涌方向',down:'往香港方向'},{id:'HOK',name:'香港',up:'往東涌方向'}
  ]},
  AEL:{id:'AEL',name:'機場快線',stations:[
    {id:'HOK',name:'香港',down:'往機場/博覽館方向'},{id:'KOW',name:'九龍',up:'往香港方向',down:'往機場/博覽館方向'},{id:'TSY',name:'青衣',up:'往香港方向',down:'往機場/博覽館方向'},{id:'AIR',name:'機場',up:'往香港方向',down:'往博覽館方向'},{id:'AWE',name:'博覽館',up:'往機場方向'}
  ]},
  SIL:{id:'SIL',name:'南港島線',stations:[
    {id:'SOH',name:'海怡半島',down:'往海洋公園/黃竹坑/利東/南港島方向'},{id:'LET',name:'利東',up:'往海怡半島方向',down:'往南港島方向'},{id:'WCH',name:'黃竹坑',up:'往海怡半島方向',down:'往南港島方向'},{id:'OCP',name:'海洋公園',up:'往海怡半島方向',down:'往南港島方向'}
  ]}
};

// 狀態
let currentLineID=null,currentStationID=null,scheduleCache=new Map,refreshInterval,isOnline=navigator.onLine,autocompleteIndex=-1,lastUpdateTime=0;

// DOM
const lineButtonsContainer=document.getElementById('line-buttons'),stationButtonsContainer=document.getElementById('station-buttons-container'),stationSelectionSection=document.getElementById('station-selection'),scheduleDisplaySection=document.getElementById('schedule-display'),upTimeTableBody=document.querySelector('#up-time-table tbody'),downTimeTableBody=document.querySelector('#down-time-table tbody'),upCaption=document.getElementById('up-caption'),downCaption=document.getElementById('down-caption'),upTimeTable=document.getElementById('up-time-table'),downTimeTable=document.getElementById('down-time-table'),offlineIndicator=document.getElementById('offline-indicator'),themeToggle=document.getElementById('theme-toggle'),sunIcon=document.querySelector('.sun-icon'),moonIcon=document.querySelector('.moon-icon'),mainElement=document.querySelector('main'),navbarElement=document.querySelector('.navbar'),navbarSearchContainer=document.getElementById('navbar-search-container'),searchInputNav=document.getElementById('station-search-nav'),searchClearNav=document.getElementById('search-clear-nav'),autocompleteDropdown=document.getElementById('autocomplete-dropdown'),breadcrumbContainer=document.querySelector('.breadcrumb-container'),breadcrumbElement=document.getElementById('breadcrumb');

// 搜索
function initSearch(){
  searchInputNav.addEventListener('input', debounce(handleSearch, 300));
  searchInputNav.addEventListener('keydown', handleSearchKeydown);
  searchClearNav.addEventListener('click', clearSearch);
  document.addEventListener('click',(e)=>{ if(!e.target.closest('.navbar-search-container') && !e.target.closest('.autocomplete-dropdown')) closeAutocomplete(); });
}
function debounce(func,wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>func(...args),wait); } }
function handleSearch(e){
  const query=e.target.value.trim();
  searchClearNav.style.display=query?'flex':'none';
  if(!query){ filterStations(''); closeAutocomplete(); return; }
  filterStations(query); showAutocomplete(query);
}
function handleSearchKeydown(e){
  const items=autocompleteDropdown.querySelectorAll('.autocomplete-item');
  if(e.key==='ArrowDown'){ e.preventDefault(); autocompleteIndex=Math.min(autocompleteIndex+1,items.length-1); updateAutocompleteSelection(items); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); autocompleteIndex=Math.max(autocompleteIndex-1,-1); updateAutocompleteSelection(items); }
  else if(e.key==='Enter'){ e.preventDefault(); if(autocompleteIndex>=0 && items[autocompleteIndex]) items[autocompleteIndex].click(); }
  else if(e.key==='Escape'){ clearSearch(); }
}
function updateAutocompleteSelection(items){ items.forEach((item,idx)=>{ if(idx===autocompleteIndex) item.classList.add('selected'); else item.classList.remove('selected'); }); }
function showAutocomplete(query){
  const matches=[];
  for(const lineId in stations){
    const lineData=stations[lineId];
    lineData.stations.forEach(station=>{
      if(station.name.toLowerCase().includes(query.toLowerCase())){
        matches.push({...station,lineId,lineName:lineData.name});
      }
    });
  }
  if(matches.length===0){ closeAutocomplete(); return; }
  autocompleteDropdown.innerHTML=''; autocompleteIndex=-1;
  matches.slice(0,5).forEach(match=>{
    const item=document.createElement('div'); item.className='autocomplete-item';
    const lineIndicator=document.createElement('div'); lineIndicator.className='line-indicator'; lineIndicator.style.backgroundColor=lineColors[match.lineId];
    const stationName=document.createElement('span'); stationName.textContent=match.name;
    const lineName=document.createElement('span'); lineName.textContent=` (${match.lineName})`; lineName.style.color='var(--subtle-text-color)';
    item.appendChild(lineIndicator); item.appendChild(stationName); item.appendChild(lineName);
    item.addEventListener('click',()=>{
      searchInputNav.value=match.name; clearSearch(); handleLineClick(match.lineId); setTimeout(()=>{ handleStationClick(match.id,match.up,match.down); },100);
    });
    autocompleteDropdown.appendChild(item);
  });
  const navbarHeight=navbarElement.offsetHeight; autocompleteDropdown.style.top=`${navbarHeight+4}px`;
  autocompleteDropdown.style.display='block';
  const items=autocompleteDropdown.querySelectorAll('.autocomplete-item'); autocompleteIndex=items.length>0?0:-1; updateAutocompleteSelection(items);
}
function closeAutocomplete(){ autocompleteDropdown.style.display='none'; autocompleteIndex=-1; }
function clearSearch(){ searchInputNav.value=''; searchClearNav.style.display='none'; filterStations(''); closeAutocomplete(); }
function filterStations(query){
  const buttons=document.querySelectorAll('#station-buttons-container .btn-station');
  buttons.forEach(button=>{ const name=button.textContent.toLowerCase(); button.style.display=name.includes(query.toLowerCase())?'flex':'none'; });
}

// 版面計算
function adjustMainPadding(){ const navbarHeight=navbarElement.offsetHeight; const breadcrumbHeight=breadcrumbContainer.offsetHeight; mainElement.style.paddingTop=`${navbarHeight+breadcrumbHeight}px`; }

// 動態麵包屑位置
function adjustBreadcrumbPosition(){ const navbarHeight=navbarElement.offsetHeight; breadcrumbContainer.style.top=`${navbarHeight}px`; }

// 麵包屑
function updateBreadcrumb(){
  let html=`<div class="breadcrumb-item"><span class="breadcrumb-link" onclick="navigateToHome()">主頁</span></div>`;
  if(currentLineID){
    html+=`<div class="breadcrumb-item"><span class="breadcrumb-link" onclick="navigateToLineSelection()">${lines[currentLineID]}</span></div>`;
    if(currentStationID){ const stationName=stationNames[currentStationID]||currentStationID; html+=`<div class="breadcrumb-item"><span class="breadcrumb-current">${stationName}</span></div>`; }
  }
  breadcrumbElement.innerHTML=html;
}

// 主題
function initTheme(){ const saved=localStorage.getItem('theme'); document.documentElement.setAttribute('data-theme',saved||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light')); updateThemeIcon(); }
function toggleTheme(){ const cur=document.documentElement.getAttribute('data-theme'); const next=cur==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme',next); localStorage.setItem('theme',next); updateThemeIcon(); }
function updateThemeIcon(){ const cur=document.documentElement.getAttribute('data-theme'); if(sunIcon) sunIcon.style.display=cur==='dark'?'none':'block'; if(moonIcon) moonIcon.style.display=cur==='dark'?'block':'none'; }

// 導航
function navigateToHome(){
  currentLineID=null; currentStationID=null;
  document.getElementById('line-selection').style.display='block';
  stationSelectionSection.style.display='none';
  scheduleDisplaySection.style.display='none';
  navbarSearchContainer.classList.add('show');
  adjustBreadcrumbPosition();
  document.querySelectorAll('#station-buttons-container .btn-station').forEach(btn=>{
    btn.classList.remove('active'); btn.setAttribute('aria-pressed','false');
    btn.style.backgroundColor='var(--card-background-color)'; btn.style.color='var(--text-color)'; btn.style.borderColor='var(--border-color)';
    const indicator=btn.querySelector('.line-color-indicator'); if(indicator) indicator.style.opacity='1';
  });
  document.querySelectorAll('#line-buttons .btn-station').forEach(btn=>{
    btn.classList.remove('active'); btn.setAttribute('aria-pressed','false');
    const id=btn.id; if(lineColors[id]){ btn.style.setProperty('background-color',lineColors[id],'important'); btn.style.setProperty('color','#FFFFFF','important'); btn.style.setProperty('border-color',lineColors[id],'important'); }
  });
  lineButtonsContainer.style.pointerEvents='none'; setTimeout(()=>{ lineButtonsContainer.style.pointerEvents='auto'; },200);
  updateBreadcrumb(); localStorage.removeItem('currentLineID'); localStorage.removeItem('currentStationID'); adjustMainPadding();
}
function navigateToLineSelection(){
  currentStationID=null;
  document.getElementById('line-selection').style.display='none';
  stationSelectionSection.style.display='block';
  scheduleDisplaySection.style.display='none';
  document.querySelectorAll('#station-buttons-container .btn-station').forEach(btn=>{
    btn.classList.remove('active'); btn.setAttribute('aria-pressed','false');
    btn.style.backgroundColor='var(--card-background-color)'; btn.style.color='var(--text-color)'; btn.style.borderColor='var(--border-color)';
    const indicator=btn.querySelector('.line-color-indicator'); if(indicator) indicator.style.opacity='1';
  });
  updateBreadcrumb(); localStorage.removeItem('currentStationID');
}

// 按鈕渲染
function renderLineButtons(){
  lineButtonsContainer.innerHTML='';
  for(const id in lines){
    const button=document.createElement('button'); button.className='btn-station'; button.id=id; button.textContent=lines[id];
    button.setAttribute('role','button'); button.setAttribute('aria-pressed',id===currentLineID?'true':'false'); button.setAttribute('tabindex','0');
    if(lineColors[id]){ button.style.setProperty('background-color',lineColors[id],'important'); button.style.setProperty('color','#FFFFFF','important'); button.style.setProperty('border-color',lineColors[id],'important'); }
    button.addEventListener('click',()=>handleLineClick(id));
    button.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handleLineClick(id); } });
    lineButtonsContainer.appendChild(button);
  }
  setTimeout(()=>{ document.querySelectorAll('#line-buttons .btn-station').forEach(btn=>{ const id=btn.id; if(lineColors[id]){ btn.style.setProperty('background-color',lineColors[id],'important'); btn.style.setProperty('color','#FFFFFF','important'); btn.style.setProperty('border-color',lineColors[id],'important'); } }); },100);
  adjustMainPadding();
}
function renderStationButtons(){
  const data=stations[currentLineID]; if(!data) return;
  stationButtonsContainer.innerHTML='';
  const group=document.createElement('div'); group.id=`${currentLineID}-line-buttons`; group.style.display='flex'; group.className='button-group';
  data.stations.forEach(station=>{
    const button=document.createElement('button'); button.className='btn-station'; button.id=`${currentLineID}-${station.id}`;
    button.dataset.stationId=station.id; button.dataset.upCaption=station.up||''; button.dataset.downCaption=station.down||''; button.textContent=station.name;
    button.setAttribute('role','button'); button.setAttribute('aria-pressed',station.id===currentStationID?'true':'false'); button.setAttribute('tabindex','0');
    if(lineColors[currentLineID]){ const indicator=document.createElement('div'); indicator.className='line-color-indicator'; indicator.style.backgroundColor=lineColors[currentLineID]; button.appendChild(indicator);
      if(station.id===currentStationID){ button.style.setProperty('background-color',lineColors[currentLineID],'important'); button.style.setProperty('color','#FFFFFF','important'); button.style.setProperty('border-color',lineColors[currentLineID],'important'); indicator.style.opacity='0'; }
    }
    button.addEventListener('click',()=>handleStationClick(station.id,station.up,station.down));
    button.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handleStationClick(station.id,station.up,station.down); } });
    group.appendChild(button);
  });
  stationButtonsContainer.appendChild(group);
  adjustMainPadding();
}

// 互動
function handleLineClick(lineId){
  document.querySelectorAll('#line-buttons .btn-station').forEach(btn=>{
    btn.setAttribute('aria-pressed','false'); btn.classList.remove('active');
    if(lineColors[btn.id]){ btn.style.setProperty('background-color',lineColors[btn.id],'important'); btn.style.setProperty('color','#FFFFFF','important'); btn.style.setProperty('border-color',lineColors[btn.id],'important'); }
  });
  const active=document.getElementById(lineId);
  if(active){ active.classList.add('active'); active.setAttribute('aria-pressed','true'); if(lineColors[lineId]){ active.style.setProperty('background-color',lineColors[lineId],'important'); active.style.setProperty('color','#FFFFFF','important'); active.style.setProperty('border-color',lineColors[lineId],'important'); } }
  if(lineId!==currentLineID){
    currentLineID=lineId; currentStationID=null; scheduleDisplaySection.style.display='none'; localStorage.setItem('currentLineID',currentLineID);
    renderStationButtons();
    document.getElementById('line-selection').style.display='none'; stationSelectionSection.style.display='block';
    navbarSearchContainer.classList.add('show'); adjustBreadcrumbPosition(); updateBreadcrumb();
  }
}
function handleStationClick(stationId,upCaptionText,downCaptionText){
  if(stationId===currentStationID) return;
  document.querySelectorAll(`#${currentLineID}-line-buttons .btn-station`).forEach(btn=>{
    btn.setAttribute('aria-pressed','false'); btn.classList.remove('active');
    btn.style.removeProperty('background-color'); btn.style.removeProperty('color'); btn.style.removeProperty('border-color');
    btn.style.backgroundColor='var(--card-background-color)'; btn.style.color='var(--text-color)'; btn.style.borderColor='var(--border-color)';
    const indicator=btn.querySelector('.line-color-indicator'); if(indicator) indicator.style.opacity='1';
  });
  const active=document.getElementById(`${currentLineID}-${stationId}`);
  if(active){
    active.classList.add('active'); active.setAttribute('aria-pressed','true');
    if(lineColors[currentLineID]){ active.style.setProperty('background-color',lineColors[currentLineID],'important'); active.style.setProperty('color','#FFFFFF','important'); active.style.setProperty('border-color',lineColors[currentLineID],'important'); const indicator=active.querySelector('.line-color-indicator'); if(indicator) indicator.style.opacity='0'; }
  }
  currentStationID=stationId; localStorage.setItem('currentStationID',currentStationID);
  if(upCaptionText){ upCaption.textContent=upCaptionText; upTimeTable.style.display='table'; } else { upTimeTable.style.display='none'; }
  if(downCaptionText){ downCaption.textContent=downCaptionText; downTimeTable.style.display='table'; } else { downTimeTable.style.display='none'; }
  stationSelectionSection.style.display='none'; scheduleDisplaySection.style.display='block';
  updateBreadcrumb(); forceUpdateTimeTable();
}

// 時間表
function forceUpdateTimeTable(){ if(!currentLineID||!currentStationID) return; const key=`${currentLineID}-${currentStationID}`; scheduleCache.delete(key); lastUpdateTime=0; updateTimeTable(); }
async function updateTimeTable(){
  if(!currentLineID||!currentStationID) return;
  const now=Date.now(); if(now-lastUpdateTime<5000) return; lastUpdateTime=now;
  const key=`${currentLineID}-${currentStationID}`; if(scheduleCache.has(key)){ const {data,timestamp}=scheduleCache.get(key); if(now-timestamp<15000){ renderTimeTable(data); return; } }
  showLoadingState();
  try{
    const response=await fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${currentLineID}&sta=${currentStationID}`,{cache:'no-cache'});
    if(!response.ok) throw new Error(zhTWMessages.networkError);
    const data=await response.json();
    if(data.status===1){ scheduleCache.set(key,{data,timestamp:now}); renderTimeTable(data); } else { throw new Error(data.message||zhTWMessages.dataError); }
  }catch(err){ console.error('Failed to fetch schedule:',err); showErrorState(); }
}
function renderTimeTable(apiResponse){
  const dataKey=`${currentLineID}-${currentStationID}`,stationSchedule=apiResponse.data[dataKey];
  if(!stationSchedule){ upTimeTableBody.innerHTML=`<tr><td colspan="3" class="error-message">${zhTWMessages.noSchedule}</td></tr>`; downTimeTableBody.innerHTML=`<tr><td colspan="3" class="error-message">${zhTWMessages.noSchedule}</td></tr>`; return; }
  const currentTime=new Date(apiResponse.curr_time);
  let upTrains=(stationSchedule.UP||[]).filter(t=>new Date(t.time)>currentTime);
  let downTrains=(stationSchedule.DOWN||[]).filter(t=>new Date(t.time)>currentTime);
  if(currentLineID==='TKL'){
    if(currentStationID==='POA'){ downTrains=downTrains.filter(t=>t.dest!=='LHP'); }
    else if(currentStationID==='LHP'){ downTrains=downTrains.filter(t=>t.dest!=='POA'); }
    else if(currentStationID==='TIK'){ upTrains=upTrains.filter(t=>t.dest==='POA'||t.dest==='LHP'); }
  }else if(currentLineID==='AEL'){
    if(currentStationID==='AIR'){ downTrains=downTrains.filter(t=>t.dest==='HOK'); }
    else if(currentStationID==='TSY'||currentStationID==='KOW'){ upTrains=upTrains.filter(t=>t.dest==='AIR'||t.dest==='AWE'); downTrains=downTrains.filter(t=>t.dest==='HOK'); }
  }
  upTrains.sort((a,b)=>new Date(a.time)-new Date(b.time)); downTrains.sort((a,b)=>new Date(a.time)-new Date(b.time));
  upTrains=upTrains.slice(0,3); downTrains=downTrains.slice(0,3);
  upTimeTableBody.innerHTML=''; downTimeTableBody.innerHTML='';
  upTrains.forEach(t=>upTimeTableBody.appendChild(createTrainRow(t,currentTime)));
  downTrains.forEach(t=>downTimeTableBody.appendChild(createTrainRow(t,currentTime)));
}
function createTrainRow(train,currentTime){
  const row=document.createElement('tr'),departure=new Date(train.time),timeStr=departure.toTimeString().slice(0,5),mins=Math.round((departure-currentTime)/60000),dest=stationNames[train.dest]||train.dest;
  const timeCell=document.createElement('td'); const timeText=document.createElement('span'); timeText.textContent=`${timeStr} (還有 ${mins} 分鐘)`; if(mins<=3) timeText.classList.add('time-urgent'); else if(mins<=6) timeText.classList.add('time-upcoming'); timeCell.appendChild(timeText); row.appendChild(timeCell);
  const destCell=document.createElement('td'); destCell.textContent=dest; row.appendChild(destCell);
  const platCell=document.createElement('td'); platCell.textContent=train.plat||'-'; row.appendChild(platCell);
  return row;
}
function showLoadingState(){ const html=`<tr><td colspan="3" class="loading-indicator">${zhTWMessages.loading}</td></tr>`; upTimeTableBody.innerHTML=html; downTimeTableBody.innerHTML=html; }
function showErrorState(){ const html=`<tr><td colspan="3" class="error-message">${zhTWMessages.dataError}</td></tr>`; upTimeTableBody.innerHTML=html; downTimeTableBody.innerHTML=html; }

// 在線狀態
function updateOnlineStatus(){ isOnline=navigator.onLine; if(isOnline){ offlineIndicator.classList.remove('show'); offlineIndicator.textContent=zhTWMessages.offline; if(currentLineID&&currentStationID) updateTimeTable(); } else { offlineIndicator.classList.add('show'); } }

// 啟動
function initApp(){
  initTheme(); initSearch(); themeToggle.addEventListener('click',toggleTheme);
  renderLineButtons();
  window.addEventListener('online',updateOnlineStatus); window.addEventListener('offline',updateOnlineStatus); updateOnlineStatus();
  window.addEventListener('resize',()=>{ adjustMainPadding(); adjustBreadcrumbPosition(); }); adjustMainPadding(); adjustBreadcrumbPosition();
  updateBreadcrumb();
  const savedLineID=localStorage.getItem('currentLineID'),savedStationID=localStorage.getItem('currentStationID');
  if(savedLineID&&lines[savedLineID]){
    handleLineClick(savedLineID);
    if(savedStationID){
      setTimeout(()=>{ const btn=document.querySelector(`[data-station-id="${savedStationID}"]`); if(btn){ const up=btn.dataset.upCaption,down=btn.dataset.downCaption; handleStationClick(savedStationID,up,down); } else { const first=document.querySelector(`#${savedLineID}-line-buttons .btn-station`); if(first) first.click(); } },0);
    }
  }else{
    document.getElementById('line-selection').style.display='block';
    navbarSearchContainer.classList.add('show');
    adjustBreadcrumbPosition();
  }
  refreshInterval=setInterval(()=>{ if(isOnline) updateTimeTable(); },30000);
}
document.addEventListener('DOMContentLoaded',initApp);
</script>
</body>
</html>